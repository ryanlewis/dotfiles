#!/bin/bash
# Install programming language runtimes AND CLI tools via mise aqua backend
# Falls back to asdf if mise unavailable (language runtimes only)
#
# This script installs:
#   - Language runtimes: Node.js, Python, Go, Bun (via mise or asdf)
#   - CLI tools: 21 tools via mise aqua backend (bat, fd, eza, gh, kubectl, etc.)
#
# Version hash: {{ include "dot_tool-versions.tmpl" | sha256sum }}
set -e

# Skip if quick install mode
if [[ "${QUICK_INSTALL:-}" == "true" ]]; then
    echo "‚è≠Ô∏è  Skipping language runtime installation (quick mode)"
    exit 0
fi

# Ensure ~/.local/bin is in PATH for mise/asdf binary
export PATH="$HOME/.local/bin:$PATH"

if command -v mise &> /dev/null; then
    echo "üöÄ Installing language runtimes and CLI tools via mise..."
    cd "$HOME"
    mise install || echo "‚ö†Ô∏è  Some installations failed, continuing..."

    # Verify installations
    echo ""
    echo "‚úÖ Verifying language runtimes:"
    command -v node >/dev/null 2>&1 && echo "  ‚úì Node.js: $(node --version)" || echo "  ‚ö†Ô∏è  Node.js not available"
    command -v python3 >/dev/null 2>&1 && echo "  ‚úì Python: $(python3 --version 2>&1)" || echo "  ‚ö†Ô∏è  Python not available"
    command -v go >/dev/null 2>&1 && echo "  ‚úì Go: $(go version)" || echo "  ‚ö†Ô∏è  Go not available"
    command -v bun >/dev/null 2>&1 && echo "  ‚úì Bun: $(bun --version)" || echo "  ‚ö†Ô∏è  Bun not available"

    echo ""
    echo "‚úì Language runtime setup complete via mise"

elif command -v asdf &> /dev/null; then
    # Fallback to asdf if mise not available
    echo "üì¶ Using asdf (mise not available)..."

    # Set ASDF_DATA_DIR for compatibility
    export ASDF_DATA_DIR="${ASDF_DATA_DIR:-$HOME/.asdf}"

    echo "üöÄ Setting up programming language runtimes..."

    # Add asdf plugins if not already added
    add_plugin() {
        local plugin=$1
        if ! asdf plugin list | grep -q "^${plugin}$"; then
            echo "üì¶ Adding ${plugin} plugin..."
            asdf plugin add "${plugin}"
        fi
    }

    # Install Node.js
    add_plugin nodejs
    echo "üì¶ Installing Node.js..."
    if [[ -f "$HOME/.tool-versions" ]]; then
        NODE_VERSION=$(grep "^nodejs " "$HOME/.tool-versions" | awk '{print $2}')
        if [[ -n "$NODE_VERSION" ]]; then
            asdf install nodejs "${NODE_VERSION}" || echo "‚ö†Ô∏è  Node.js installation failed, continuing..."
            asdf set nodejs "${NODE_VERSION}"
        fi
    fi

    # Install Python (via Miniconda)
    add_plugin python
    echo "üì¶ Installing Python..."
    if [[ -f "$HOME/.tool-versions" ]]; then
        PYTHON_VERSION=$(grep "^python " "$HOME/.tool-versions" | awk '{print $2}')
        if [[ -n "$PYTHON_VERSION" ]]; then
            # Note: Python installation may fail due to Conda ToS - that's OK
            asdf install python "${PYTHON_VERSION}" 2>/dev/null || echo "‚ö†Ô∏è  Python installation failed (likely Conda ToS issue), continuing..."
            asdf set python "${PYTHON_VERSION}" 2>/dev/null || true
        fi
    fi

    # Install Go
    add_plugin golang
    echo "üì¶ Installing Go..."
    if [[ -f "$HOME/.tool-versions" ]]; then
        GO_VERSION=$(grep "^golang " "$HOME/.tool-versions" | awk '{print $2}')
        if [[ -n "$GO_VERSION" ]]; then
            asdf install golang "${GO_VERSION}" || echo "‚ö†Ô∏è  Go installation failed, continuing..."
            asdf set golang "${GO_VERSION}"
        fi
    fi

    # Reshim to ensure all binaries are available
    asdf reshim

    # Verify installations
    echo ""
    echo "‚úÖ Verifying language runtimes:"
    command -v node >/dev/null 2>&1 && echo "  ‚úì Node.js: $(node --version)" || echo "  ‚ö†Ô∏è  Node.js not available"
    command -v python3 >/dev/null 2>&1 && echo "  ‚úì Python: $(python3 --version 2>&1)" || echo "  ‚ö†Ô∏è  Python not available"
    command -v go >/dev/null 2>&1 && echo "  ‚úì Go: $(go version)" || echo "  ‚ö†Ô∏è  Go not available"

    echo ""
    echo "‚úì Language runtime setup complete via asdf"

else
    echo "‚ö†Ô∏è  Neither mise nor asdf found, skipping language installation"
    exit 0
fi

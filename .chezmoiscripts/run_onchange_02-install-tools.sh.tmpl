#!/bin/bash
# Install command-line tools NOT managed by mise aqua backend
# Most tools are now managed via mise aqua (see dot_tool-versions.tmpl)
# This script only installs tools not available in the aqua registry:
#   - btop (asset naming issue in aqua registry)
#   - httpie (not in aqua, httpie-go is different)
#   - broot (not in aqua registry)
#   - tldr/tealdeer (tlrc available but different implementation)
#
# Version hash: {{ include "dot_tool-versions.tmpl" | sha256sum }}
set -e

# Ensure ~/.local/bin and mise shims are in PATH
mkdir -p "$HOME/.local/bin"
export PATH="$HOME/.local/share/mise/shims:$HOME/.local/bin:$PATH"

echo "ðŸ› ï¸ Installing command-line tools (non-aqua)..."

# Helper function to get architecture
get_arch() {
    local arch=$(uname -m)
    case "$arch" in
        x86_64) echo "x86_64" ;;
        aarch64|arm64) echo "arm64" ;;
        *) echo "$arch" ;;
    esac
}

ARCH=$(get_arch)

# Install btop
if ! command -v btop &> /dev/null; then
    echo "ðŸ“Š Installing btop..."
    {{ if eq .chezmoi.os "darwin" -}}
    brew install btop
    {{ else if eq .chezmoi.os "linux" -}}
    if command -v apt &> /dev/null; then
        sudo apt-get update -qq && sudo apt-get install -y -qq btop
    elif command -v dnf &> /dev/null; then
        sudo dnf install -y btop
    elif command -v pacman &> /dev/null; then
        sudo pacman -S --noconfirm btop
    else
        # Binary installation fallback
        BTOP_VERSION="1.3.2"
        if [[ "$ARCH" == "x86_64" ]]; then
            BTOP_ARCH="x86_64-linux-musl"
        elif [[ "$ARCH" == "arm64" ]]; then
            BTOP_ARCH="aarch64-linux-musl"
        fi

        if [[ -n "${BTOP_ARCH:-}" ]]; then
            wget -qO /tmp/btop.tbz "https://github.com/aristocratos/btop/releases/download/v${BTOP_VERSION}/btop-${BTOP_ARCH}.tbz"
            tar -xjf /tmp/btop.tbz -C /tmp
            if [[ -f /tmp/btop/bin/btop ]]; then
                mv /tmp/btop/bin/btop "$HOME/.local/bin/"
                chmod +x "$HOME/.local/bin/btop"
                echo "âœ“ btop installed successfully"
            fi
            rm -rf /tmp/btop.tbz /tmp/btop
        fi
    fi
    {{ end -}}
fi

# Install tldr
if ! command -v tldr &> /dev/null; then
    echo "ðŸ“– Installing tldr..."
    {{ if eq .chezmoi.os "darwin" -}}
    brew install tldr
    {{ else if eq .chezmoi.os "linux" -}}
    TLDR_VERSION="3.3.0"
    if [[ "$ARCH" == "x86_64" ]]; then
        TLDR_ARCH="x86_64-unknown-linux-musl"
    elif [[ "$ARCH" == "arm64" ]]; then
        TLDR_ARCH="aarch64-unknown-linux-musl"
    fi

    if [[ -n "${TLDR_ARCH:-}" ]]; then
        # Download tldr binary directly (tealdeer implementation)
        # Fix: Correct filename format for tealdeer releases
        if [[ "$ARCH" == "x86_64" ]]; then
            TLDR_FILE="tealdeer-linux-x86_64-musl"
        elif [[ "$ARCH" == "arm64" ]]; then
            TLDR_FILE="tealdeer-linux-aarch64-musl"
        fi

        if wget -qO "$HOME/.local/bin/tldr" "https://github.com/dbrgn/tealdeer/releases/download/v${TLDR_VERSION}/${TLDR_FILE}" 2>/dev/null; then
            chmod +x "$HOME/.local/bin/tldr"
            echo "âœ“ tldr installed successfully"
        else
            echo "âš ï¸  Failed to download tldr, skipping..."
        fi
    fi
    {{ end -}}
fi

# Install httpie
if ! command -v http &> /dev/null; then
    echo "ðŸŒ Installing httpie..."
    {{ if eq .chezmoi.os "darwin" -}}
    brew install httpie
    {{ else if eq .chezmoi.os "linux" -}}
    if command -v apt &> /dev/null; then
        sudo apt-get update -qq && sudo apt-get install -y -qq httpie
    elif command -v dnf &> /dev/null; then
        sudo dnf install -y httpie
    elif command -v pacman &> /dev/null; then
        sudo pacman -S --noconfirm httpie
    fi
    {{ end -}}
fi

# Install broot
if ! command -v broot &> /dev/null; then
    echo "ðŸŒ³ Installing broot..."
    {{ if eq .chezmoi.os "darwin" -}}
    brew install broot
    {{ else if eq .chezmoi.os "linux" -}}
    BROOT_VERSION="1.54.0"
    if [[ "$ARCH" == "x86_64" ]]; then
        BROOT_ARCH="x86_64-unknown-linux-musl"
    elif [[ "$ARCH" == "arm64" ]]; then
        BROOT_ARCH="aarch64-unknown-linux-musl"
    fi

    if [[ -n "${BROOT_ARCH:-}" ]]; then
        wget -qO /tmp/broot.zip "https://github.com/Canop/broot/releases/download/v${BROOT_VERSION}/broot_${BROOT_VERSION}.zip" 2>/dev/null || \
        wget -qO /tmp/broot.zip "https://github.com/Canop/broot/releases/download/v${BROOT_VERSION}/broot-v${BROOT_VERSION}-${BROOT_ARCH}.zip" 2>/dev/null

        if [[ -f /tmp/broot.zip ]]; then
            unzip -qo /tmp/broot.zip -d /tmp 2>/dev/null || true
            # Try to find the broot binary
            if [[ -f "/tmp/${BROOT_ARCH}/broot" ]]; then
                mv "/tmp/${BROOT_ARCH}/broot" "$HOME/.local/bin/"
                chmod +x "$HOME/.local/bin/broot"
                echo "âœ“ broot installed successfully"
            elif [[ -f "/tmp/broot" ]]; then
                mv "/tmp/broot" "$HOME/.local/bin/"
                chmod +x "$HOME/.local/bin/broot"
                echo "âœ“ broot installed successfully"
            else
                # Try downloading as tar.gz instead
                wget -qO /tmp/broot.tar.gz "https://github.com/Canop/broot/releases/download/v${BROOT_VERSION}/broot-${BROOT_ARCH}.tar.gz" 2>/dev/null
                if tar -xzf /tmp/broot.tar.gz -C /tmp 2>/dev/null; then
                    if [[ -f "/tmp/broot" ]]; then
                        mv "/tmp/broot" "$HOME/.local/bin/"
                        chmod +x "$HOME/.local/bin/broot"
                        echo "âœ“ broot installed successfully"
                    else
                        echo "âš ï¸  Failed to extract broot, skipping..."
                    fi
                    rm -f /tmp/broot.tar.gz
                else
                    echo "âš ï¸  Failed to download broot, skipping..."
                fi
            fi
            rm -rf /tmp/broot.zip /tmp/${BROOT_ARCH} 2>/dev/null || true
        else
            echo "âš ï¸  Failed to download broot, skipping..."
        fi
    fi
    {{ end -}}
fi

# Install biome (via npm)
if ! command -v biome &> /dev/null; then
    echo "ðŸ§¹ Installing biome..."
    if command -v npm &> /dev/null; then
        npm install --global @biomejs/biome
    else
        echo "âš ï¸  npm not found, skipping biome installation. Install Node.js first."
    fi
fi

# Install eza (macOS only - Linux uses mise aqua)
{{ if eq .chezmoi.os "darwin" -}}
if ! command -v eza &> /dev/null; then
    echo "ðŸ¦Ž Installing eza..."
    brew install eza
fi
{{ end -}}

# Install ktlint (macOS only)
{{ if eq .chezmoi.os "darwin" -}}
if ! command -v ktlint &> /dev/null; then
    echo "ðŸ…º Installing ktlint..."
    brew install ktlint
fi
{{ end -}}

echo "âœ“ All non-aqua tools installed/updated successfully"
